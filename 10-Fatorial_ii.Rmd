# ANÁLISE DE UM EXPERIMENTO FATORIAL COM 2 FATORES, COM INTERAÇÃO SIGNIFICATIVA

Para obtenção da análise de variância, vamos supor o seguinte ensaio em que foram estudados os efeitos de 4 inseticidas em 2 doses diferentes sobre a produção da cultura do milho em kg/parcela. Dados estão disponíveis online em [inseticidas.txt](https://raw.githubusercontent.com/arpanosso/ExpAgr_2020/master/dados/inseticidas.txt)

|Trat|	Rep.1	|Rep.2|	Rep.3|	Total|
|:--:|:--:|:--:|:--:|:--:|
|	$I_1D_1$|	58|	45|	47|	**150**|
|$I_1D_2$|	61|	65|	47|	**173**|
|$I_2D_1$|	31|	35|	29|	**95**|
|$I_2D_2$|	43|	51|	49|	**143**|
|$I_3D_1$|	45|	55|	79|	**179**|
|$I_3D_2$|	31|	37|	37|	**105**|
|$I_4D_1$|	78|	83|	62|	**223**|
|$I_4D_2$|	36|	34|	34|	**104**|
|	**Total**|	**383**|	**405**|	**384**|	**1172**|

## Obtenção da análise de variância

O ensaio foi montado de acordo com o delineamento inteiramente causalizado, e portanto, a análise de variância preliminar, obtida da maneira usual, foi a seguinte:
$$
\begin{aligned}
SQ_{Total} &= (58^2+45^2+\cdots +34^2)-\frac{1175^2}{8 \cdot 3} \\
&=5813,33
\end{aligned}
$$
$$
\begin{aligned}
SQ_{Trat} &= \frac{1}{3} (150^2+173^2+\cdots +104^2)-\frac{1175^2}{8 \cdot 3} \\
&=46
\end{aligned}
$$

$$
\begin{aligned}
SQ_{Res} &= SQ_{Total} - SQ_{Trat}
&=5813,33 - 4605,33
&=1208,00
\end{aligned}
$$

Quadro de Análise de Variância Preliminar:

|Causas de Variação|	GL|	SQ|	QM|	F|
|---|---|----|----|----|
|Trat.|	7|	4605,33|	657,90|	8,71*|
|Res|	16|	1208,0|	75,50||	
|Total|	23|	5813,13|	| 

**Conclusão**: O teste é significativo ao nível de $1\%$ de probabilidade, logo, rejeitamos a hipótese da nulidade ($H_0$), e concluímos que os efeitos dos tratamentos diferem entre si em relação à característica analisada, com um grau de confiança superior a $99\%$ de probabilidade.

Devemos agora, desdobrar a soma de quadrado e os graus de liberdade de tratamentos para estudas os efeitos principais e a interação entre os fatores.

Para facilitar os cálculos, utilizamos um quadro auxiliar como o seguinte:

Quadro de totais

| (3) |$I_1$|$I_2$|$I_3$|$I_4$|Total|
|:---:|:---:|:---:|:---:|:---:|:---:|
|$D_1$|150 | 95|  179|223|647|
|$D_2$|173 |143 | 105| 104|525|
|**Total**|323 | 238|  284|327|1172|

Então, as somas de quadrados são obtidas da seguinte maneira:

**1. Soma de quadrados devido ao efeito de Inseticidas:**

$$
\begin{aligned}
SQ_{Ef.Inseticida} &= \frac{1}{r_I}[T_{I_1}^2+T_{I_2}^2+T_{I_3}^2+T_{I_4}^2] - \frac{G^2}{I\cdot J} \\
&= \frac{1}{6}[323^2+238^2+284^2+327^2] - \frac{1172^2}{24} \\
&= 860,33
\end{aligned}
$$

**2. Soma de quadrados devido ao efeito de Doses:**

$$
\begin{aligned}
SQ_{Ef.Dose} &= \frac{1}{r_D}[T_{D_1}^2+T_{D_2}] - \frac{G^2}{I\cdot J} \\
&= \frac{1}{12}[647^2+525^2] - \frac{1172^2}{24} \\
&= 620,16
\end{aligned}
$$


**3. Soma de quadrados devido ao efeito da Interação Inseticida x Doses:**

$$
\begin{aligned}
SQ_{Interação\;I\times D} &= SQ_{S,F}-SQ_{Ef.Ins.}-SQ_{Ef.Dos.} \\
SQ_{I,D} &= \frac{1}{r_{SF}}(T_{I_1D_1}^2+T_{I_1D_2}^2+\cdots +T_{I_4D_2}^2) - C \\
                  &= \frac{1}{3}(150^2+173^2+\cdots + 104^2) - \frac{94,24^2}{24} \\
                  &= 4605,33 \\
assim, \\

SQ_{Interação\;I\times D} &= SQ_{S,F}-SQ_{Ef.Ins.}-SQ_{Ef.Dos.} \\
&=4605,33-860,33-620,16 \\
&=3124,84
\end{aligned}
$$
   
Portanto, temos o seguinte quadro de análise de variância:
   
```{r echo=FALSE}
library(kableExtra)
tb<-data.frame(CV=c("Efeito de Inseticida (I)","Efeito de Doses (D)","Ef. da Interação (IxD)","(Tratamentos)","Resíduos","Total"),
               GL=c("3","1","3","7","16","23"),
               SQ=c("860,33","620,16","3124,84","4605,33","1208,00","5813,33"),
               QM=c("286,78","620,16","1041,61","--","75,50","--"),
               "F"=c("3,80*","8,21*","13,80**","--","--","--"))
names(tb)<-c("Causas de Variação","GL","SQ","QM","F")
kable(tb)%>%
 kable_styling(bootstrap_options = "striped", full_width = F) %>% 
  row_spec(c(4,6), bold = T)
```


Valores de F da tabela para Inseticida ($3 \times 16 GL$): $\begin{cases}5\%=3,24 \\ 1\%=5,29 \end{cases}$

Valores de F da tabela para Fungicida ($1 \times 16 GL$): $\begin{cases}5\%=4,49 \\ 1\%=8,53 \end{cases}$

Valores de F da tabela para Interação $S\times F$ ($3 \times 16 GL$): $\begin{cases}5\%=3,24 \\ 1\%=5,29 \end{cases}$

**Conclusões**

**Para efeito de Inseticida**: O teste foi significativo ao nível de $5\%$ de probabilidae, indicando que devemos rejeitar $H_0$ e concluir que os inseticidas possuem efeitos diferentes sobre a produção da cultura do milho.

**Para efeito de Dose**: O teste foi significativo ao nível de $5\%$ de probabilidae, indicando que devemos rejeitar $H_0$ e concluir que as dosagens possuem efeitos diferentes sobre a produção da cultura do milho.

**Para efeito da Interação (I $\times$ D)**: O teste foi significativo ao nível de $1\%$ de probabilidae, indicando que devemos rejeitar $H_0$ e concluir que os inseticidas e dosagens agem conjuntamente sobre a produção da cultura do milho, ou seja, inseticidas e dosagens não agem de maneira independente.

Devemos portanto, desdobrar o efeito da interação para estudar os efeitos de cada um dos fatores dentro dos níveis do outro fator.


## Desdobrando a interação $I\times D$, para estudar os efeitos do fator **DOSES** em cada nível do fator **INSETICIDA** (D d. I):

$$
SQ_{Dd.I_1} = \frac{1}{3}(150^2+173^2) - \frac{323^2}{6}=8,16 \\
SQ_{Dd.I_2} = \frac{1}{3}(95^2+143^2) - \frac{238^2}{6}=384,00 \\
SQ_{Dd.I_3} = \frac{1}{3}(179^2+105^2) - \frac{284^2}{6}=912,66 \\
SQ_{Dd.I_4} = \frac{1}{3}(223^2+104^2) - \frac{327^2}{6}=2360,17
$$

**Verificação**: $SQ_{Dd.I_1}+SQ_{Dd.I_2}+SQ_{Dd.I_3}+SQ_{Dd.I_4}=SQ_{D}+SQ_{D\times I}$

Então, o quadro de análise de variância com desdobramento da interação $I\times D$, estudando-se o efeito de doses dentro de cada inseticida será o seguinte:

```{r echo=FALSE}
library(kableExtra)
tb<-data.frame(CV=c("Efeito de Inseticida (I)","Doses d.I1","Doses d.I2","Doses d.I3","Doses d.I4","(Tratamentos)","Resíduos","Total"),
               GL=c("3","1","1","1","1","7","16","23"),
               SQ=c("860,33","88,16","384,00","912,66","2360,17","4605,33","1208,00","--"),
               QM=c("286,78","88,16","384,00","912,66","2360,17","--","75,50","--"),
               "F"=c("3,80*","1,17","5,09*","12,09**","31.26**","--","--","--"))
names(tb)<-c("Causas de Variação","GL","SQ","QM","F")
kable(tb)%>%
 kable_styling(bootstrap_options = "striped", full_width = F) %>% 
  row_spec(c(6,8), bold = T)
```

Valores de F da tabela para Inseticidas ($3 \times 16 GL$): $\begin{cases}5\%=3,24 \\ 1\%=5,29 \end{cases}$

Valores de F da tabela para Doses d. Inseticidas ($1 \times 16 GL$): $\begin{cases}5\%=4,49 \\ 1\%=8,53 \end{cases}$

## Desdobrando a interação $I \times D$, para estudar os efeitos do fator **INSETICIDAS** dentro de cada nível do fator **DOSE** (D d. I):

$$
SQ_{Id.D_1} = \frac{1}{3}(150^2+95^2+179^2+223^2) - \frac{647^2}{12}=2880,92 \\
SQ_{Id.D_2} = \frac{1}{3}(173^2+143^2+105^2+104^2) - \frac{525^2}{12}=1104,25 \\
$$

**Verificação**: $SQ_{Id.D_1}+SQ_{Id.D_2}=SQ_{I}+SQ_{I \times D}$


```{r echo=FALSE}
library(kableExtra)
tb<-data.frame(CV=c("Efeito de Inseticida (I)","Inseticida d.D1","Inseticida d.D2","(Tratamentos)","Resíduos","Total"),
               GL=c("1","3","3","7","16","23"),
               SQ=c("620,16","2880,92","1104,25","4605,33","1208,00","5813,33"),
               QM=c("620,16","960,31","368,08","--","75,50","--"),
               "F"=c("8,21*","12,72**","4.88*","--","--","--"))
names(tb)<-c("Causas de Variação","GL","SQ","QM","F")
kable(tb)%>%
 kable_styling(bootstrap_options = "striped", full_width = F) %>% 
  row_spec(c(4,6), bold = T)
```

Valores de F da tabela para Doses ($1 \times 16 GL$): $\begin{cases}5\%=4,49 \\ 1\%=8,53 \end{cases}$

Valores de F da tabela para Inseticidas d. Doses ($3 \times 16 GL$): $\begin{cases}5\%=3,24 \\ 1\%=5,29 \end{cases}$

Para completar a análise de variância, e obter conclusões mais específicas sobre o efeito dos inseticidas em cada dosagem, podemos aplicar um teste de comparação de médias.

## Teste de Tukey para a comparação de médias

Construção do Quadro de Médias a partir do Quadro de totais:

Quadro auxiliar de totais:  

| $(3)$ |$I_1$|$I_2$|$I_3$|$I_4$|Total|
|:---:|:---:|:---:|:---:|:---:|:---:|
|$D_1$|150/3 | 95/3|  179/3|223/3|647/12|
|$D_2$|173/3 |143/3| 105/3| 104/3|525/12|
|**Total**|323/6 | 238/6|  284/6|327/6|1172/24|

Quadro de médias:

|  |$I_1$|$I_2$|$I_3$|$I_4$|**Média Doses**|
|:---:|:---:|:---:|:---:|:---:|:---:|
|$D_1$|50,00 |31,67|59,67|74,32|53,92|
|$D_2$|53,67 |47,67|35,00|34,67|43,75|
|**Média Inseticidas**|53,83 | 39,67| 47,33|54,5|48,83|

## Para comparar médias de Inseticidas na Dose 1 (I d. $D_1$)

$$
\Delta = dms=q \cdot s(m) = q_{(4 \times 16 GL)}\cdot \sqrt{\frac{QM_{Res}}{r}}=4,05\cdot \sqrt{\frac{75,50}{3}}=20,34\;kg/parcela
$$

|Inseticidas d. $D_1$| $\hat{m_{I_4}}$| $\hat{m_{I_3}}$|$\hat{m_{I_1}}$|$\hat{m_{I_2}}$|
|:---|:---:|:---:|:---:|:---:|
|$\hat{m_{I_4}}$||14,66|24,33\*|42,66\*|
|$\hat{m_{I_3}}$|--|--|9,67|28,00\*|
|$\hat{m_{I_1}}$|--|--|--|18,37|


## Para comparar médias de Inseticidas na Dose 2 (I d. $D_2$)

$$
\Delta = dms=q \cdot s(m) = q_{(4 \times 16 GL)}\cdot \sqrt{\frac{QM_{Res}}{r}}=4.05\cdot \sqrt{\frac{75.50}{3}}=20.34\;kg/parcela
$$

|Inseticidas d. $D_1$| $\hat{m_{I_1}}$| $\hat{m_{I_2}}$|$\hat{m_{I_3}}$|$\hat{m_{I_4}}$|
|:---|:---:|:---:|:---:|:---:|
|$\hat{m_{I_1}}$||10,00|22,67\*|23,00\*|
|$\hat{m_{I_2}}$|--|--|12,67|13,00|
|$\hat{m_{I_3}}$|--|--|--|0,33|


**Resultado do teste de Tukey**

Médias seguidas pela mesma letra, minúsculas nas linhas e maiúsculas nas colunas, não diferem entre si pelo teste de Tukey ao nível de $5\%$ de probabilidade.

|  |$I_1$|$I_2$|$I_3$|$I_4$|**Média Doses**|
|:---:|:---|:---|:---|:---|:---:|
|$D_1$|50,00 Abc |31,67 Bc |59,67 Aab|74,32 Aa|53,92|
|$D_2$|53,67 Aa |47,67 Aab |35,00 Bb|34,67 Bb|43,75|
|**Média Inseticidas**|53,83 | 39,67| 47,33|54,5|48,83|

## Cálculo do coeficiente de variação do experimento

$$
CV=100\cdot \frac{\sqrt{QM_{res}}}{\hat{m}}=100\cdot \frac{8,69}{48,83}=17,80\%
$$

**Aplicação no R**

![](R.png)


**Utilizando as funções básicas e o pacote agricolae**
```{r}
# Carregando o pacote para análise de variância
library(agricolae)
library(tidyverse)

# Definindo o caminho do banco de dados
caminho<-"https://raw.githubusercontent.com/arpanosso/ExpAgr_2020/master/dados/inseticidas.txt"

# Entrada da dados
dados<-read.table(caminho,h=TRUE)

#Guardando os fatores (tratamentos de solo e fungicidas) e a variável resposta (y)
ins<-as.factor(dados$Ins)
dose<-as.factor(dados$Dos)
y<-dados$Y

# Gráfico da interação
dados %>% 
  group_by(Ins,Dos) %>% 
  summarise(Y = mean(Y)) %>% 
  ggplot(aes(x=Ins, y=Y,col=as.factor(Dos)))+
  geom_line()+
  labs(x="Inseticidas",y="Variável Y",col="Doses")

dados %>% 
  group_by(Ins,Dos) %>% 
  summarise(Y = mean(Y)) %>% 
  ggplot(aes(x=Dos, y=Y,col=as.factor(Ins)))+
  geom_line()+
  labs(x="Doses",y="Variável Y",col="Inseticidas")
```
**Analise considerando o delineamento de tratamentos**
```{r}
mod <- aov(y~ins + dose + ins:dose)
anova(mod)
```

**Medias dos efeitos principais e da interação**
```{r}
model.tables(mod,type="means")
```

**SE A INTERAÇÃO FOR SIGNIFICATIVA**

**Desdobramento de Doses dentro Inseticidas**

```{r}
# Redefinindo o modelo para o estudo das interações
modab <- aov(y~ins/dose) # Colocar os Controles locais, blocos, se for o caso
effects(modab)
effects(modab)[5:8]
summary(modab,split=list("ins:dose"=list(In1=1, 
                                         In2=2,
                                         In3=3,
                                         In4=4
                                         ))) 
```

**Desdobramento de Inseticida dentro de Dose**

```{r}
# Redefinindo o modelo para o estudo das interações
modba <- aov(y~dose/ins) # Colocar os Controles locais, blocos, se for o caso
effects(modba)
effects(modba)[3:8]
summary(modba,split=list("dose:ins"=list(Dose1=c(1,3,5),
                                         Dose2=c(2,4,6)
                                                ))) 
```

**Utilizando ao pacrote ExpDes.pt, mais prático**

```{r}
# Carregando o pacote para análise de variância
library(ExpDes.pt)

# Definindo o caminho do banco de dados
caminho<-"https://raw.githubusercontent.com/arpanosso/ExpAgr_2020/master/dados/solofungi.txt"

# Entrada da dados
dados<-read.table(caminho,h=TRUE)

#Guardando os fatores (tratamentos de solo e fungicidas) e a variável resposta (y)
solos<-dados$S
fungicida<-dados$F
y<-dados$y

# Utilizando a função fat2.dic do pacote ExpDes.pt
fat2.dic(solos,fungicida,y,fac.names = c("Trat.Solo", "Fungicida"))
```